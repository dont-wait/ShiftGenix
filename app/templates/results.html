{% extends "base.html" %}

{% block title %}Kết quả lịch trực - {{ app_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="bi bi-table"></i> Lịch trực chi tiết
        </h2>
        <p class="text-muted">Xem và quản lý lịch trực đã tạo</p>
    </div>
</div>

<!-- View Options -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="viewType" id="viewCalendar" checked 
                   onchange="switchView('calendar')">
            <label class="btn btn-outline-primary" for="viewCalendar">
                <i class="bi bi-calendar3"></i> Lịch
            </label>
            
            <input type="radio" class="btn-check" name="viewType" id="viewTable" 
                   onchange="switchView('table')">
            <label class="btn btn-outline-primary" for="viewTable">
                <i class="bi bi-table"></i> Bảng
            </label>
            
            <input type="radio" class="btn-check" name="viewType" id="viewEmployee" 
                   onchange="switchView('employee')">
            <label class="btn btn-outline-primary" for="viewEmployee">
                <i class="bi bi-person"></i> Theo nhân viên
            </label>
        </div>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-success" onclick="exportToExcel()">
            <i class="bi bi-file-earmark-excel"></i> Xuất Excel
        </button>
        <button class="btn btn-primary" onclick="printSchedule()">
            <i class="bi bi-printer"></i> In
        </button>
    </div>
</div>

<!-- Calendar View -->
<div id="calendarView" class="view-container">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th width="100">Ngày</th>
                            <th>Ca sáng (07:00-15:00)</th>
                            <th>Ca chiều (15:00-23:00)</th>
                            <th>Ca đêm (23:00-07:00)</th>
                        </tr>
                    </thead>
                    <tbody id="calendarTableBody">
                        <!-- Will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Table View -->
<div id="tableView" class="view-container" style="display: none;">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Ngày</th>
                            <th>Ca</th>
                            <th>Vị trí</th>
                            <th>Nhân viên</th>
                            <th>Chức vụ</th>
                        </tr>
                    </thead>
                    <tbody id="flatTableBody">
                        <!-- Will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Employee View -->
<div id="employeeView" class="view-container" style="display: none;">
    <div class="row g-3" id="employeeCards">
        <!-- Will be populated by JS -->
    </div>
</div>

<!-- Empty State -->
<div id="emptyState" style="display: none;">
    <div class="text-center text-muted py-5">
        <i class="bi bi-inbox" style="font-size: 4rem;"></i>
        <p class="mt-3">Chưa có lịch trực</p>
        <a href="/schedule" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Tạo lịch mới
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let scheduleData = null;

function loadSchedule() {
    const stored = localStorage.getItem('latestSchedule');
    if (stored) {
        scheduleData = JSON.parse(stored);
        renderCalendarView();
        document.getElementById('emptyState').style.display = 'none';
    } else {
        document.getElementById('calendarView').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
    }
}

function renderCalendarView() {
    if (!scheduleData || !scheduleData.schedule) return;
    
    const tbody = document.getElementById('calendarTableBody');
    tbody.innerHTML = scheduleData.schedule.map((day, idx) => `
        <tr>
            <td class="fw-bold">
                ${day.date}<br>
                <small class="text-muted">${day.day_of_week}</small>
            </td>
            <td>${renderShiftCell(day.shifts.morning)}</td>
            <td>${renderShiftCell(day.shifts.afternoon)}</td>
            <td>${renderShiftCell(day.shifts.night)}</td>
        </tr>
    `).join('');
}

function renderShiftCell(shiftData) {
    if (!shiftData) return '<em class="text-muted">Chưa xếp</em>';
    
    let html = '';
    for (const [position, staffIds] of Object.entries(shiftData)) {
        html += `<div class="mb-2">
            <strong class="text-primary">${position}:</strong><br>
            ${staffIds.map(id => `<span class="badge bg-secondary me-1">${id}</span>`).join('')}
        </div>`;
    }
    return html || '<em class="text-muted">Trống</em>';
}

function switchView(viewType) {
    document.querySelectorAll('.view-container').forEach(el => {
        el.style.display = 'none';
    });
    
    if (viewType === 'calendar') {
        document.getElementById('calendarView').style.display = 'block';
        renderCalendarView();
    } else if (viewType === 'table') {
        document.getElementById('tableView').style.display = 'block';
        renderTableView();
    } else if (viewType === 'employee') {
        document.getElementById('employeeView').style.display = 'block';
        renderEmployeeView();
    }
}

function renderTableView() {
    if (!scheduleData || !scheduleData.schedule) return;
    
    const tbody = document.getElementById('flatTableBody');
    const rows = [];
    
    scheduleData.schedule.forEach(day => {
        ['morning', 'afternoon', 'night'].forEach(shiftType => {
            const shift = day.shifts[shiftType];
            if (shift) {
                for (const [position, staffIds] of Object.entries(shift)) {
                    staffIds.forEach(staffId => {
                        rows.push(`
                            <tr>
                                <td>${day.date}</td>
                                <td><span class="badge bg-info">${shiftType}</span></td>
                                <td>${position}</td>
                                <td><strong>${staffId}</strong></td>
                                <td><span class="badge bg-primary">Bác sĩ</span></td>
                            </tr>
                        `);
                    });
                }
            }
        });
    });
    
    tbody.innerHTML = rows.join('');
}

function renderEmployeeView() {
    const staff = JSON.parse(localStorage.getItem('staffData') || '[]');
    const container = document.getElementById('employeeCards');
    
    container.innerHTML = staff.map(employee => `
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-person-badge"></i> ${employee.name}
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Chức vụ:</strong> 
                        <span class="badge bg-info">${employee.role}</span>
                    </p>
                    <p class="mb-2">
                        <strong>Tổng ca trực:</strong> 
                        <span class="badge bg-success">15</span>
                    </p>
                    <hr>
                    <small class="text-muted">Lịch trực chi tiết:</small>
                    <ul class="list-unstyled mt-2 small">
                        <li>Ca sáng: 5</li>
                        <li>Ca chiều: 5</li>
                        <li>Ca đêm: 5</li>
                    </ul>
                </div>
            </div>
        </div>
    `).join('');
}

function exportToExcel() {
    alert('Chức năng xuất Excel đang được phát triển');
}

function printSchedule() {
    window.print();
}

document.addEventListener('DOMContentLoaded', loadSchedule);
</script>
{% endblock %}